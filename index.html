<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="./core/dist/core.min.js"></script>
    <script type="module">
      import Config from "./backbone.json"
      window["backbone"] = {
        user: async (params = { name: "", permissions: "", address: "" }) => {
          if (!window["backbone"].app) {
            console.log("Error: load app before authenticating")
            return
          }
          if (!window["backbone"].id) window["backbone"].id = await bb.User()

          let manifest = Config.app
          if (manifest) {
            if (typeof manifest !== "object") manifest = JSON.parse(manifest)

            // Get app manifest
            // Register app to Id
            await window["backbone"].id.registerApp(manifest)

            // Ask user to authenticate
            if (!(await window["backbone"].id.authenticate(params))) throw new Error("authentication failed")

            // Check if user actually authenticated
            window["backbone"].app_profile = await window["backbone"].id.isAuthenticated({
              address: manifest.address,
            })
            if (typeof window["backbone"].app_profile != "object") throw new Error("loading app profile failed")
          } else {
            throw new Error("no manifest found")
          }
        },
      }
    </script>
    <title>Backbone App</title>
  </head>
  <body>
    <div id="UI"></div>
    <script type="module">
      import Config from "./backbone.json"
      import app from "./src/app/index.ts"
      import ui from "./src/ui/index.tsx"
      let dev_address = localStorage.getItem("ADDRESS") || "0x" + bb.Crypto.buf2hex(bb.Crypto.randomBytes(32))
      window["backbone"].app = await bb.Core({ config: { ...Config.settings, address: dev_address }, app })
      ui()
    </script>
  </body>
</html>
